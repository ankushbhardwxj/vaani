name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # ── macOS .dmg ───────────────────────────────────────────────────────────────
  build-macos:
    name: Build macOS (.dmg)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2" --locked

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-release-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-release-

      - name: Run tests
        working-directory: src-tauri
        run: cargo test

      - name: Build Tauri app
        working-directory: src-tauri
        run: cargo tauri build

      - name: Ad-hoc code sign
        run: |
          APP_PATH=$(find src-tauri/target/release/bundle/macos -name "*.app" | head -1)
          codesign --force --deep --sign - "$APP_PATH"

      - name: Package as DMG
        run: |
          APP_PATH=$(find src-tauri/target/release/bundle/macos -name "*.app" | head -1)
          hdiutil create \
            -volname "Vaani" \
            -srcfolder "$APP_PATH" \
            -ov -format UDZO \
            "Vaani-${{ github.ref_name }}-macos.dmg"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Vaani-macos-dmg
          path: "Vaani-${{ github.ref_name }}-macos.dmg"

  # ── Linux .deb + .AppImage ──────────────────────────────────────────────────
  build-linux:
    name: Build Linux (.deb, .AppImage)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2" --locked

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-release-${{ hashFiles('src-tauri/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-release-

      - name: Build Tauri app
        working-directory: src-tauri
        run: cargo tauri build

      - name: Collect Linux artifacts
        run: |
          mkdir -p linux-artifacts
          cp src-tauri/target/release/bundle/deb/*.deb linux-artifacts/ 2>/dev/null || true
          cp src-tauri/target/release/bundle/appimage/*.AppImage linux-artifacts/ 2>/dev/null || true

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Vaani-linux
          path: linux-artifacts/

  # ── GitHub Release ──────────────────────────────────────────────────────────
  create-release:
    name: Create GitHub Release
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download macOS DMG
        uses: actions/download-artifact@v4
        with:
          name: Vaani-macos-dmg

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: Vaani-linux
          path: linux-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Vaani-${{ github.ref_name }}-macos.dmg
            linux-artifacts/*
          generate_release_notes: true
          body: |
            ## Install

            ### macOS — Homebrew (recommended)
            ```bash
            brew install --cask vaani
            ```

            ### macOS — Manual
            1. Download `Vaani-${{ github.ref_name }}-macos.dmg` below
            2. Open the DMG and drag **Vaani.app** to `/Applications`
            3. Remove the quarantine flag:
            ```bash
            xattr -rd com.apple.quarantine /Applications/Vaani.app
            ```
            4. Open Vaani from Spotlight or `/Applications`

            ### Linux — Debian/Ubuntu
            ```bash
            sudo dpkg -i vaani_*.deb
            ```

            ### Linux — AppImage
            ```bash
            chmod +x Vaani_*.AppImage && ./Vaani_*.AppImage
            ```

            ---
            Grant **Microphone** and **Accessibility** permissions on first launch
            (System Settings → Privacy & Security on macOS).
